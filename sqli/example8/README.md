# Example8

## Code

```php
<?php

  require_once('../header.php');
  require_once('db.php');
	$sql = "SELECT * FROM users ORDER BY `";
	$sql .= mysql_real_escape_string($_GET["order"])."`";
	$result = mysql_query($sql);
	
	if ($result) {
		?>
		<table  class='table table-striped'>
		<tr>
			<th><a href="example8.php?order=id">id</th>
			<th><a href="example8.php?order=name">name</th>
			<th><a href="example8.php?order=age">age</th>
		</tr>
		<?php
		while ($row = mysql_fetch_assoc($result)) {
			echo "<tr>";
    			echo "<td>".$row['id']."</td>";
    			echo "<td>".$row['name']."</td>";
    			echo "<td>".$row['age']."</td>";
			echo "</tr>";
		}	
		echo "</table>";
	}
    require '../footer.php';
?>
```

## Writeup

In this code we can't use normal sql injection, we can't add some **UNION** clausole after the **ORDER BY** clausole and the **mysql_real_escape_string** will escape special characters.

This function escape the **`** char?

Let's test it:

```sql
age`%23
```

The answer is no. We can use it as statement separator.

We can use logical operator (**AND**, **OR**) and the **SLEEP** function as a **distinguisher**:

```sql
order=name` or sleep(5)%23
```

The **OR** logical operator work because strings that the first letter is not a number are valuated as **FALSE**, if we use an **AND** operator the sleep is never executed.

The sleep return always 0, that is valuated as **FALSE**.

We can use the **if()** statement as a distinguisher:

```sql
order=name` or if(length(database())>2, sleep(1), NULL)%23
```

We can use the **binary search** to find the correct length of the database name:

```
length(database())>M
length(database())<N
```

When **|N - M| <= 2** we can try:

```
length(database())=N
```

After found the length, we can guess the value by using the set of printable characters **[32, 127]**.

We can use the **ASCII()** function to obtain the int value of a char and **SUBSTRING(string, begin_index, end_index)**, as this:

```
ascii(substring(database(),1,1))=M
```

Iterating the process using the binary search we can guess the value of the database name.

We can also use this process to guess all database informations.